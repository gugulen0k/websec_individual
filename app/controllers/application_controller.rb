class ApplicationController < ActionController::Base
  helper_method :current_user

  # ðŸ”´ ÐžÐ‘Ð ÐÐ‘ÐžÐ¢ÐšÐ ÐžÐ¨Ð˜Ð‘ÐžÐš: Ð“Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¸ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¹
  rescue_from StandardError, with: :handle_standard_error
  rescue_from ActiveRecord::RecordNotFound, with: :handle_not_found
  rescue_from ActiveRecord::RecordInvalid, with: :handle_validation_error
  rescue_from ActionController::ParameterMissing, with: :handle_parameter_missing

  def current_user
    @current_user ||= User.find_by(id: session[:user_id])
  end

  def require_login
    unless current_user
      redirect_to login_path, alert: "Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð²Ð¾Ð¹Ð´Ð¸Ñ‚Ðµ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ"
    end
  end

  def require_admin
    require_login
    unless session[:role] == "admin"
      # ðŸ“ Ð›ÐžÐ“Ð˜Ð ÐžÐ’ÐÐÐ˜Ð•: ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð½ÐµÑÐ°Ð½ÐºÑ†Ð¸Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Ð°Ð´Ð¼Ð¸Ð½-Ð¿Ð°Ð½ÐµÐ»Ð¸
      SecurityLogger.log_unauthorized_access(
        current_user,
        'admin_access',
        request,
        { required_role: 'admin', user_role: session[:role] }
      )

      redirect_to user_dashboard_path, alert: "ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¿Ñ€Ð°Ð²"
    end
  end

  def require_manager
    require_login
    unless [ "manager", "admin" ].include?(session[:role])
      # ðŸ“ Ð›ÐžÐ“Ð˜Ð ÐžÐ’ÐÐÐ˜Ð•: ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð½ÐµÑÐ°Ð½ÐºÑ†Ð¸Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Ð¿Ð°Ð½ÐµÐ»Ð¸ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ð°
      SecurityLogger.log_unauthorized_access(
        current_user,
        'manager_access',
        request,
        { required_role: 'manager', user_role: session[:role] }
      )

      redirect_to user_dashboard_path, alert: "ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¿Ñ€Ð°Ð²"
    end
  end

  private

  # ðŸ”´ ÐžÐ‘Ð ÐÐ‘ÐžÐ¢Ð§Ð˜ÐšÐ˜ ÐžÐ¨Ð˜Ð‘ÐžÐš

  # ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±ÐºÐ¸ "Ð·Ð°Ð¿Ð¸ÑÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"
  def handle_not_found(exception)
    ErrorLogger.log_error(exception, user: current_user, request: request, context: {
      controller: controller_name,
      action: action_name,
      params: params.to_unsafe_h.except('controller', 'action')
    })

    flash[:alert] = "Ð—Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼Ð°Ñ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð²Ð²ÐµÐ´Ñ‘Ð½Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…."
    redirect_to(request.referer || root_path)
  end

  # ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸
  def handle_validation_error(exception)
    ErrorLogger.log_validation_error(exception.record, user: current_user, request: request)

    flash[:alert] = "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ñ„Ð¾Ñ€Ð¼Ñ‹: #{exception.record.errors.full_messages.join(', ')}"
    redirect_to(request.referer || root_path)
  end

  # ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð²
  def handle_parameter_missing(exception)
    ErrorLogger.log_warning(
      "Missing required parameter: #{exception.param}",
      user: current_user,
      request: request,
      context: { controller: controller_name, action: action_name }
    )

    flash[:alert] = "ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð·Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð²ÑÐµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð¿Ð¾Ð»Ñ."
    redirect_to(request.referer || root_path)
  end

  # ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ñ… Ð¾ÑˆÐ¸Ð±Ð¾Ðº
  def handle_standard_error(exception)
    # Ð›Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ð¾ÑˆÐ¸Ð±ÐºÑƒ
    ErrorLogger.log_critical(exception, user: current_user, request: request, context: {
      controller: controller_name,
      action: action_name,
      params: params.to_unsafe_h.except('controller', 'action')
    })

    flash[:alert] = "ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¸ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ Ð¸Ð»Ð¸ Ð¾Ð±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ðº Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñƒ."

    # Ð’ Ñ€ÐµÐ¶Ð¸Ð¼Ðµ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð¾ÑˆÐ¸Ð±ÐºÑƒ
    raise exception if Rails.env.development?

    redirect_to root_path
  end
end
